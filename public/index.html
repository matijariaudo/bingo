<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#000" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300&display=swap" rel="stylesheet">
    
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css">

  <title>Document</title>
  <style>
  body{
    background-color: #161616;
    color:#FFF;
    font-family: 'Fredoka', sans-serif;
  }
  /* Estilos para el botón de carga personalizado */
  .custom-file-upload {
    border: 1px solid #ccc;
    display: inline-block;
    padding: 6px 12px;
    cursor: pointer;
    background-color: #14958e;
    color:#FFF;
    border-radius: 4px;
    transition: background-color 0.3s ease;
  }

  .custom-file-upload:hover {
    background-color: #e0e0e0;
  }

  .songs_list{
    
  }

  /* Ocultar el input file */
  input[type="file"] {
    display: none;
  }
  
  </style>
</head>
<body>
  <div class="container-fluid"  style="padding: 0px;;margin: 0px;padding: 0px;">
    <div class="capa capa_0 row" style="padding: 0px;background: #000;height: 100vh;margin: 0px;padding: 30px;text-align: center;">
      
    <div class="offset-4 col-4" style="padding-top: 100px;"><img src="img/loading.gif" style="width: 100%;"><br>Loading..</div>
    </div>
    <div class="capa capa_1 row" style="padding: 0px;;margin: 0px;padding: 0px;text-align: center;">

    <div class="row" style="padding: 10px;background-color: #000;margin: 0px;">
      <input type="text" class="form-control" onclick="capa(2);$('#txt_buscar').focus().val('')"placeholder="Song name.." style="width: 100%;background-color:rgba(255,255,255,.12);border:0px;border-radius: 100px;color:#FFCC00;">
    </div>
    <div class="container">
      <div class="col-12" style="margin-top: 20px;">
        <button class="btn" id="" data="1" style="background-color: #FFCC00;margin-bottom: 10px;" onclick="$('#uploadForm').show()"><i class="zmdi zmdi-plus" ></i> ADD BINGO</button>
        <br>
        <button class="btn btn_filter" id="btn_filter_1" data="1"><i class="zmdi zmdi-long-arrow-right"></i></button>
        <button class="btn btn_filter" id="btn_filter_2" data="2"><i class="zmdi zmdi-long-arrow-up"></i></button>
        <button class="btn btn_filter" id="btn_filter_3" data="3"><i class="zmdi zmdi-collection-music"></i></button>
      </div>
      <form id="uploadForm" enctype="multipart/form-data" style="display: none;">
        <div class="col-12" style="padding: 0px 30px;margin-top: 40px;">
          <div class="row" style="padding: 10px;border-radius: 10px;border: 1px solid #ccc;border-style: dashed;">
            <div class="col-4 p-1">
              <label for="archivo" class="custom-file-upload" style="width: 100%;color: #000;background-color:#FFCC00;border-radius:100px;border: 0px;width: 100%;">
                <i class="zmdi zmdi-camera" style="font-size: 1.5em;margin-bottom: px;"></i> 
                <input type="file" name="archivo" id="archivo" />
              </label>
            </div>
            <div class="col-7 p-1"><input type="text" class="form-control" id="archivo_name" placeholder="Bingo name.." style="width: 100%;background-color:rgba(255,255,255,.12);border:0px;border-radius: 100px;color:#FFCC00;"></div>
            <div class="col-1 p-1" style="color: #ccc;font-size: 1.4em;">
              <i onclick="$('#uploadForm').hide()" style="float: right;margin-top: 8px;" class="zmdi zmdi-delete"></i>
            </div>
              <div class="col-12 p-1">
              <button class="btn" type="submit" style="color: #000;background-color:#FFCC00;width: 100%;border-radius:100px;">Send</button>
            </div>
          </div>
        </div>
        
      </form>
      
      <div class="col-12" id="bingos" style="padding: 0px 0px 10px 0px;">
      
      </div>
      <div class="col-12" style="padding:0px;color:#FFCC00;font-size: .6em;margin-bottom: 70px;">User Id: <b class="user_id"></b> </div>  
  
    </div>
    </div>
    <div class="capa capa_2 row" style="margin: 0px;padding: 0px;text-align: center;">
        
        <div class="row" style="padding: 10px;background-color: #000;margin: 0px;">
          <input type="text" onfocus="$(this).val('');$(this).keyup()" autocomplete="off" class="form-control" id="txt_buscar" placeholder="Song name.." style="width: 100%;background-color:rgba(255,255,255,.12);border:0px;border-radius: 100px;color:#FFCC00;">
        </div>
        <div class="co-12 songs" style="padding:30px 20px 100px 20px">

        </div>
    </div>
    <div class="capa capa_3 row" style="padding: 40px 30px;background: #000;min-height: 100%;">
      <div class="col-12">
      <center><img src="img/loading.gif" style="width: 90px;" id="img_show_loading"></center>
      <img src="" alt="" id="img_show" onload="$(this).show();$('#img_show_loading').hide()" style="width: 100%;border:1px solid #FFF">
      <button class="btn" onclick="capa(1)" style="border-radius:100px;background:rgb(100,100,100);color:rgba(200,200,200);margin-top:30px">
        <i class="zmdi zmdi-arrow-left"></i>
        Go back
      </button>
    </div>
    </div>
  </div>

  <nav class="navbar fixed-bottom capa capa_1 capa_2" style="padding: 0px;background-color: #000;text-align: center;box-shadow: -2px 5px 30px -5px rgba(66, 66, 66, 0.75);">
    <div class="col-6 nav_div nav_div_1" onclick="capa(1)" style="border:1px solid #2f2f2f;border-width: 0px 1px 0px 0px;padding: 20px 10px;"><i class="zmdi zmdi-format-list-bulleted"></i> BINGOS</div>
    <div class="col-6 nav_div nav_div_2" onclick="capa(2)" style="border:1px solid #5e5e5e;border-width: 0px 1px 0px 0px;padding: 20px 10px"><i class="zmdi zmdi-collection-music"></i> SONGS</div>
  </nav>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>

    function capa(i){
      $(".capa").hide();
      $(".capa_"+i).show();
      $('.nav_div').css('color','#979797');
      $(".nav_div_"+i).css('color','#FFCC00');
    }
    bingos_qty=0
    capa(0)
    
    //Setting filtros
    btn_filter=localStorage.getItem('btn_filter');
    if(!btn_filter){btn_filter=3;}
    $('.btn_filter').css('background','#4e4e4e');$('#btn_filter_'+btn_filter).css('background','#FFCC00');
    $('.btn_filter').on("click",function(){ 
      $('.btn_filter').css('background','#4e4e4e');
      $(this).css('background','#FFCC00');
      btn_filter=$(this).attr("data")
      initsearch();
    })
    //Setting user
    user_id=localStorage.getItem('user_id');
    if(!user_id){user_id=generarCodigo(30);localStorage.setItem('user_id',user_id);}
    $(".user_id").html(user_id)

    initsearch()
    
    $(document).ready(function() {
    $('#archivo').change(function() {
      $("#archivo_name").val("Bingo "+(bingos_qty+1));
      $("#archivo_name").focus()
      //$('#uploadForm').submit(); // Enviar el formulario cuando se selecciona un archivo
    });

    $('#uploadForm').submit(function(e) {
      $("#uploadForm").hide()
      e.preventDefault(); // Evitar la recarga de la página al enviar el formulario
      var formData = new FormData($(this)[0]); // Obtener los datos del formulario
      var archivo_name = $('#archivo_name').val();
      formData.append('archivo_name', archivo_name);
      formData.append('user_id', user_id);
      capa(0)
      $.ajax({
        url: '/upload', // URL del servidor donde se enviarán los datos
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
          console.log(response)
          initsearch()
          
        },
        error: function(error) {
          // Manejar errores si ocurren
        }
      });
    });
  });

  

  function initsearch(){
    localStorage.setItem('btn_filter',btn_filter);
    $("#bingos").html("");
    $(".songs").html("")
    bingos_qty=0;
    capa(0)
    var myHeaders = new Headers();
    myHeaders.append("Content-Type", "application/json");
    var raw = JSON.stringify({
      user_id
    });
    var requestOptions = {
      method: 'POST',
      headers: myHeaders,
      body: raw,
      redirect: 'follow'
    };  
  fetch("/user/img", requestOptions)
    .then(response => response.json())
    .then(result =>{
      songs_data=[]
        newA=result.map(a=>{
          arrayA=a.bingo.map(b=>b.chequeado)
          l1=arrayA.slice(0,5).filter(c=>{if(c){return true;}}).length;
          l2=arrayA.slice(5,10).filter(c=>{if(c){return true;}}).length;
          l3=arrayA.slice(10,15).filter(c=>{if(c){return true;}}).length;
          l4=arrayA.slice(15,20).filter(c=>{if(c){return true;}}).length;
          l5=arrayA.slice(20,25).filter(c=>{if(c){return true;}}).length;
          const linCount=[l1,l2,l3,l4,l5].filter(c=>c==5).length;
          const maxCount=Math.max(...[l1,l2,l3,l4,l5].filter(c=>c<5))
          console.log("horizontal",[l1,l2,l3,l4,l5])
          return {linCount,maxCount}  
        })
        console.log(1)
        newB=result.map(a=>{
          l1=a.bingo.filter(a=>a.columna==0).map(b=>b.chequeado).filter(c=>{if(c){return true;}}).length;
          l2=a.bingo.filter(a=>a.columna==1).map(b=>b.chequeado).filter(c=>{if(c){return true;}}).length;
          l3=a.bingo.filter(a=>a.columna==2).map(b=>b.chequeado).filter(c=>{if(c){return true;}}).length;
          l4=a.bingo.filter(a=>a.columna==3).map(b=>b.chequeado).filter(c=>{if(c){return true;}}).length;
          l5=a.bingo.filter(a=>a.columna==4).map(b=>b.chequeado).filter(c=>{if(c){return true;}}).length;
          const linCount=[l1,l2,l3,l4,l5].filter(c=>c==5).length;
          const maxCount=Math.max(...[l1,l2,l3,l4,l5].filter(c=>c<5))
          console.log("vertical",[l1,l2,l3,l4,l5])
          return {linCount,maxCount}  
        })
        newC=result.map(a=>{
          return a.bingo.map(b=>b.chequeado).filter(c=>{if(c){return true;}}).length;
        })
        result=result.map((a,i)=>{a.lineas=newA[i].linCount;a.lineasC=newA[i].maxCount;a.verticales=newB[i].linCount;a.verticalesC=newB[i].maxCount; a.chequeados=newC[i];return a;})
        console.log(result.map(a=> {return {l:a.lineas,lc:a.lineasC,v:a.verticales,vc:a.verticalesC};}))
        if(btn_filter==1){result.sort((a,b)=>{
          if(b.lineas-a.lineas<0){return -1}
          if(b.lineasC-a.lineasC<0){return -1}
        });}
        if(btn_filter==2){result.sort((a,b)=>{
          if(b.verticales-a.verticales<0){return -1}
          if(b.verticalesC-a.verticalesC<0){return -1}
        });}
        if(btn_filter==3){result.sort((a,b)=>b.chequeados-a.chequeados);}
        result.forEach((e,t) => {
          bingos_qty++;
          console.log(e.url)
          html=``
          html+=`<div class="col-12" style="padding:20px">
            <p style="margin:0px;font-size:1.2em">${e.name || "-"}
            </p>
            <p style='color:#9e9e9e;font-size:.8em;margin:0px'>
              <a style="display:${btn_filter==1?"block":"none"}"><i class="zmdi zmdi-long-arrow-right"></i> ${e.lineas.linCount} lines | To new line: ${5-e.lineas.maxCount}  songs</a>
              <a style="display:${btn_filter==2?"block":"none"}"><i class="zmdi zmdi-long-arrow-up"></i> ${e.verticales.linCount} lines | To new line: ${5-e.verticales.maxCount}  songs</a>
              <a style="display:${btn_filter==3?"block":"none"}"><i class="zmdi zmdi-collection-music"></i> ${e.chequeados} | To end: ${25-e.chequeados} songs</a></p>         
              <button class="btn btn-xs btn_img" data_img="${e.url}" style="padding:1px 10px;margin-top:-41px;font-size:1.1em;border-radius:100px;background:rgb(100,100,100);color:rgba(200,200,200);float:left">
                <i class="zmdi zmdi-eye"></i>
              </button>
              <button class="btn btn-xs btn_delete" data_btn="${e.id}" style="padding:1px 10px;margin-top:-41px;font-size:1.1em;border-radius:100px;background:rgb(100,100,100);color:rgba(200,200,200);float:right">
                <i class="zmdi zmdi-delete"></i>
              </button>
            <div class="row" style="color:#FFF;border-radius:10px;margin-top:20px">`
          li=0;liact=0;lineas=0;
          e.bingo.forEach(s => {
              songs_data.push(s)
              html+=`<div class="col" style="background:${s.chequeado?"rgb(120, 255, 188,.1)":"rgb(242, 212, 73,.5)"};width:20%;min-width:20%;margin:0px;font-size:.7em;border:.1px solid #000;text-align:center;padding:0px;display: flex;align-items: center;justify-content: center;">${s.song}</div>`; 
              li++;
              if(s.chequeado){liact++;}
              if(li==5){if(liact==5){lineas++;};li=0;liact=0;}
          });
          html+=`</div></div>`;
          $("#bingos").append(html)
          $("#lineas_"+t).html(lineas)
        });
        
        songs_data=songs_data.map(a=>{a.realsong=a.song;a.song=a.song.replaceAll("-","").replaceAll(".","").replaceAll(" ","").trim();return a;})
        songs_data.sort((a, b) => a.song.localeCompare(b.song));
        songs_data.forEach(e => {
          iguales=songs_data.filter(a=>compararCadenas(a.song,e.song)>.9)
          songs_data=songs_data.map(a=>{if(iguales.findIndex(b=>b._id==a._id)>-1){a.song=e.song};return a});
        });
        const songs = Object.values(
          songs_data.reduce((acc, { song, ...rest }) => {
            acc[song] = acc[song] || { song, cantidad: 0, ...rest,ids:[],title:[]};
            acc[song].cantidad++;
            acc[song].ids.push(rest._id)
            acc[song].title.push(rest.realsong)
            return acc;
          }, {})
        );
        songs.sort((a, b) => a.song.localeCompare(b.song)).forEach((s,i) => {
          html_btn=`<button class="btn" id="btn_${i}" style="float:right;background:rgb(0,0,0,.3);color:rgb(255,255,255,.7);border:0px"><i class="zmdi zmdi-${s.chequeado?"delete":"check"}"></i></button>`
          $(".songs").append(`<div class="col-12 songs_list" style="padding:10px;background:${s.chequeado?"rgb(120, 255, 188,.1)":"rgb(242, 212, 73,.5)"};margin-bottom:10px;box-shadow: -2px 5px 30px -10px rgba(0,0,0,.16);border-radius:10px;text-align:left">${html_btn}${s.realsong} (${s.cantidad})</div>`)  
          $("#btn_"+i).on("click",()=>{
            act(s.ids,!s.chequeado)
          })
        
        });
        capa(1);   
        $(".btn_delete").on("click",function (e) {  
          capa(0)
          var settings = {
          "url": "/delete",
          "method": "POST",
          "timeout": 0,
          "headers": {
            "Content-Type": "application/json"
          },
          "data": JSON.stringify({
            "id": $(this).attr('data_btn'),
            "status": false
          }),
          };

          $.ajax(settings).done(function (response) {
            initsearch()
          });     
        })     
        $(".btn_img").on("click",function (e) {  
          $("#img_show").hide();
          $("#img_show_loading").show()
          $("#img_show").attr("src",$(this).attr('data_img'));
          capa(3)
        })      
    })
    .catch(error => console.log('error', error));
    }

    function compararCadenas(str1, str2) {
      const set1 = new Set(str1.split(''));
      coin=0;total=0;
      set1.forEach(e => {
        c1=str1.split('').filter(a=>a==e).length;
        c2=str2.split('').filter(a=>a==e).length;
        max=Math.max(c1,c2);
        dif=Math.abs(c1-c2);
        total+=max;
        coin+=(max-dif);
        
      });
      rta=coin/total;
      //console.log()
      return rta;
    }

    function act(ids,valor){
      var settings = {
      "url": "/cambios",
      "method": "POST",
      "timeout": 0,
      "headers": {
        "Content-Type": "application/json"
      },
      "data": JSON.stringify({ids,valor}),
    };

    $.ajax(settings).done(function (response) {
      console.log(response);
      initsearch()
    });
    }

    let dejodeescribir;
    $("#txt_buscar").on("keyup",function () {
        txt=$(this).val();
        clearInterval(dejodeescribir)
        dejodeescribir=setInterval(()=>{
          $(".songs_list").show()
          $(".songs_list").each(function(s){
            if($(this).html().toLowerCase().indexOf(txt.toLowerCase())<0){
              $(this).hide()
            }
          });
          clearInterval(dejodeescribir)
        },300)
     })


     function generarCodigo(longitud) {
      const caracteres = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let codigo = "";

      for (let i = 0; i < longitud; i++) {
        const caracterAleatorio = caracteres.charAt(Math.floor(Math.random() * caracteres.length));
        codigo += caracterAleatorio;
      }

      return codigo;
    }
    </script>
</body>
</html>
